@model ExamReviewSubmissionViewModel
@{
    ViewData["Title"] = "Chấm bài";
    var answers = Model.Answers.ToDictionary(a => a.QuestionId, a => a);
    var totalPoints = Model.Exam.Questions?.Sum(q => q.Points) ?? 0;
}

<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-semibold mb-1">
            <i class="fa-solid fa-file-pen text-primary me-2"></i>Chấm bài thi
        </h2>
        <div class="text-muted">
            <strong>@Model.Submission.Student?.FullName</strong>
        </div>
        <div class="text-muted small">
            <i class="fa-regular fa-clock me-1"></i>
            Nộp lúc: @Model.Submission.SubmittedAt?.ToString("dd/MM/yyyy HH:mm")
        </div>
    </div>

    <a asp-action="Review" asp-route-id="@Model.Exam.ExamID" class="btn btn-outline-secondary">
        <i class="fa-solid fa-arrow-left me-1"></i>Quay lại
    </a>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">

        <form asp-action="GradeSubmission" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="submissionId" value="@Model.Submission.ExamSubmissionID" />

            <div class="row g-4">

                <!-- Điểm -->
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Điểm số</label>
                    <input type="number" step="0.25" min="0" max="@totalPoints"
                           class="form-control shadow-sm"
                           name="score" value="@Model.Submission.Score" />
                    <small class="text-muted">
                        Tổng tối đa: <strong>@totalPoints</strong>
                    </small>
                </div>

                <!-- Nhận xét -->
                <div class="col-md-8">
                    <label class="form-label fw-semibold">Nhận xét của giảng viên</label>
                    <textarea name="feedback" class="form-control shadow-sm" rows="3">
                        @Model.Submission.TeacherFeedback
                    </textarea>
                </div>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary px-4">
                    <i class="fa-solid fa-floppy-disk me-1"></i> Lưu đánh giá
                </button>
            </div>
        </form>

    </div>
</div>


<!-- ===================== DANH SÁCH CÂU HỎI ===================== -->
@foreach (var question in Model.Exam.Questions?.OrderBy(q => q.DisplayOrder)
         ?? Enumerable.Empty<Question>())
{
    answers.TryGetValue(question.QuestionID, out var answer);

    <div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <strong>Câu hỏi:</strong> @question.Prompt
            </div>

            <span class="badge bg-primary">
                <i class="fa-solid fa-star me-1"></i>@question.Points điểm
            </span>
        </div>

        <div class="card-body">

            @if (question.IsMultipleChoice)
            {
                <ul class="list-group">
                    @foreach (var choice in question.Choices ?? Enumerable.Empty<Choice>())
                    {
                        var isSelected = answer?.SelectedChoiceId == choice.ChoiceID;

                        string itemClass = "list-group-item d-flex justify-content-between align-items-center";

                        if (choice.IsCorrect)
                        {
                            itemClass += " list-group-item-success";
                        }
                        else if (isSelected)
                        {
                            itemClass += " list-group-item-danger";
                        }

                        <li class="@itemClass">
                            <span>@choice.Text</span>

                            <span>
                                @if (isSelected)
                                {
                                    <span class="badge bg-primary me-1">
                                        <i class="fa-solid fa-check"></i> SV chọn
                                    </span>
                                }
                                @if (choice.IsCorrect)
                                {
                                    <span class="badge bg-success">
                                        <i class="fa-solid fa-check-double"></i> Đúng
                                    </span>
                                }
                            </span>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p class="fw-semibold mb-1">Bài làm của sinh viên:</p>
                <div class="border rounded p-3 bg-light">
                    @(answer?.AnswerText ?? "<chưa trả lời>")
                </div>
            }
        </div>
    </div>
}
