@model ExamReviewSubmissionViewModel
@{
    ViewData["Title"] = "Kết quả bài thi";
    var answers = Model.Answers.ToDictionary(a => a.QuestionId, a => a);
}

<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold">
            <i class="fa-solid fa-file-circle-check text-primary me-2"></i>
            @Model.Exam.Title
        </h2>

        <div class="mt-2">
            <span class="badge bg-primary px-3 py-2 fs-6">
                <i class="fa-solid fa-star me-1"></i>
                Điểm: @(Model.Submission.Score?.ToString("0.##") ?? "Chưa chấm")
            </span>
        </div>

        <div class="text-muted small mt-2">
            <i class="fa-solid fa-clock me-1"></i>
            Nộp lúc: @Model.Submission.SubmittedAt?.ToString("dd/MM/yyyy HH:mm")
        </div>
    </div>

    <a asp-action="Available" class="btn btn-outline-secondary shadow-sm">
        <i class="fa-solid fa-arrow-left me-1"></i>Quay lại danh sách
    </a>
</div>

@if (!string.IsNullOrWhiteSpace(Model.Submission.TeacherFeedback))
{
    <div class="alert alert-success shadow-sm">
        <i class="fa-solid fa-comment-dots me-2"></i>
        <strong>Nhận xét:</strong> @Model.Submission.TeacherFeedback
    </div>
}

@foreach (var question in Model.Exam.Questions?.OrderBy(q => q.DisplayOrder) ?? Enumerable.Empty<Question>())
{
    answers.TryGetValue(question.QuestionID, out var answer);

    <div class="card shadow-sm mb-4 border-0">
        <div class="card-header bg-light fw-semibold">
            <i class="fa-solid fa-circle-question text-primary me-1"></i>
            @question.Prompt
            <span class="badge bg-secondary text-white ms-2">@question.Points điểm</span>
        </div>

        <div class="card-body">

            @if (question.IsMultipleChoice)
            {
                <ul class="list-group mt-2">
                    @foreach (var choice in question.Choices ?? Enumerable.Empty<Choice>())
                    {
                        var isSelected = answer?.SelectedChoiceId == choice.ChoiceID;

                        string itemClass = "list-group-item d-flex justify-content-between align-items-center";

                        if (choice.IsCorrect)
                        {
                            itemClass += " list-group-item-success";
                        }
                        else if (isSelected)
                        {
                            itemClass += " list-group-item-danger";
                        }

                        <li class="@itemClass">
                            <span>@choice.Text</span>

                            <div class="d-flex gap-2">
                                @if (isSelected)
                                {
                                    <span class="badge bg-primary">
                                        <i class="fa-solid fa-check me-1"></i>Bạn chọn
                                    </span>
                                }
                                @if (choice.IsCorrect)
                                {
                                    <span class="badge bg-success">
                                        <i class="fa-solid fa-check-double me-1"></i>Đáp án đúng
                                    </span>
                                }
                            </div>
                        </li>
                    }
                </ul>
            }
            else
            {
                <div class="mt-3">
                    <p class="fw-semibold">
                        <i class="fa-solid fa-pen-fancy text-primary me-1"></i>
                        Bài làm:
                    </p>
                    <div class="border rounded p-3 bg-light">
                        @answer?.AnswerText
                    </div>
                </div>
            }

        </div>
    </div>
}
