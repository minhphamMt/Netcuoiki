@model ForumIndexViewModel
@{
    var title = Model.Class != null
        ? $"Diễn đàn lớp {Model.Class.ClassCode}"
        : Model.Course != null ? $"Diễn đàn khóa học {Model.Course.CourseName}" : "Diễn đàn";
}

<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<!-- HEADER -->
<h2 class="mb-4 d-flex align-items-center gap-3">

    <!-- nút quay lại đồng bộ -->
    <a asp-controller="Class"
       asp-action="Index"
       class="btn btn-outline-secondary btn-sm rounded-pill shadow-sm">
        <i class="fa-solid fa-arrow-left"></i>
    </a>


    <span><i class="fa-solid fa-comments text-primary me-2"></i>@title</span>
</h2>

<!-- Badges -->
<div class="mb-4 d-flex flex-wrap gap-2">
    @if (Model.Course != null)
    {
        <span class="badge bg-primary rounded-pill px-3 py-2">
            <i class="fa-solid fa-book-open me-1"></i>Khóa học: @Model.Course.CourseName
        </span>
    }
    @if (Model.Class != null)
    {
        <span class="badge bg-info text-dark rounded-pill px-3 py-2">
            <i class="fa-solid fa-school me-1"></i>Lớp: @Model.Class.ClassCode
        </span>
    }
</div>

<!-- Action Buttons -->
<div class="d-flex flex-wrap gap-2 mb-4">
    <a class="btn btn-primary rounded-pill px-4 shadow-sm"
       asp-action="CreateThread"
       asp-route-courseId="@Model.Course?.CourseID"
       asp-route-classId="@Model.Class?.ClassID">
        <i class="fa-solid fa-plus me-1"></i>Tạo chủ đề mới
    </a>

    <a class="btn btn-success rounded-pill px-4 shadow-sm"
       asp-action="AskQuestion"
       asp-route-courseId="@Model.Course?.CourseID"
       asp-route-classId="@Model.Class?.ClassID">
        <i class="fa-solid fa-circle-question me-1"></i>Đặt câu hỏi
    </a>
</div>


<div class="row">
    <!-- ================= LEFT: THREADS =================== -->
    <div class="col-lg-6">
        <div class="card shadow-sm mb-4 border-0 rounded-4">
            <div class="card-header bg-light rounded-top-4 d-flex justify-content-between align-items-center">
                <span class="fw-bold">
                    <i class="fa-solid fa-comments me-1 text-primary"></i>Chủ đề thảo luận
                </span>
                <span class="badge bg-secondary rounded-pill">@Model.Threads.Count</span>
            </div>

            <div class="card-body p-0">
                @if (!Model.Threads.Any())
                {
                    <p class="m-3 text-muted fst-italic">Chưa có chủ đề nào.</p>
                }
                else
                {
                    <div class="list-group list-group-flush">
                        @foreach (var thread in Model.Threads)
                        {
                            <a class="list-group-item list-group-item-action py-3"
                               asp-action="Thread"
                               asp-route-id="@thread.DiscussionThreadID">

                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <h5 class="mb-0 fw-semibold">@thread.Title</h5>
                                    <small class="text-muted">
                                        @thread.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                </div>

                                @if (!string.IsNullOrWhiteSpace(thread.Description))
                                {
                                    <p class="text-muted small mb-2">
                                        @thread.Description.Substring(0, Math.Min(thread.Description.Length, 120))
                                        @(thread.Description.Length > 120 ? "..." : "")
                                    </p>
                                }

                                <div class="d-flex align-items-center text-muted small gap-3">
                                    <span>
                                        <i class="fa-solid fa-user me-1"></i>@thread.CreatedBy?.FullName
                                    </span>
                                    <span>
                                        <i class="fa-solid fa-message me-1"></i>
                                        @(thread.Posts?.Count ?? 0) phản hồi
                                    </span>
                                </div>
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- ================= RIGHT: QUESTIONS =================== -->
    <div class="col-lg-6">
        <div class="card shadow-sm mb-4 border-0 rounded-4">
            <div class="card-header bg-light rounded-top-4 d-flex justify-content-between align-items-center">
                <span class="fw-bold">
                    <i class="fa-solid fa-circle-question me-1 text-primary"></i>Khu vực Hỏi & Đáp
                </span>
                <span class="badge bg-secondary rounded-pill">@Model.Questions.Count</span>
            </div>

            <div class="card-body p-0">
                @if (!Model.Questions.Any())
                {
                    <p class="m-3 text-muted fst-italic">Chưa có câu hỏi nào.</p>
                }
                else
                {
                    <div class="list-group list-group-flush">
                        @foreach (var question in Model.Questions)
                        {
                            var statusClass = question.IsResolved ? "bg-success text-white" : "bg-warning text-dark";
                            var statusText = question.IsResolved ? "Đã giải quyết" : "Đang mở";

                            <a class="list-group-item list-group-item-action py-3"
                               asp-action="Question"
                               asp-route-id="@question.QuestionID">

                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0 fw-semibold">@question.Title</h5>
                                    <span class="badge @statusClass rounded-pill px-3">@statusText</span>
                                </div>

                                <p class="text-muted small mb-2">
                                    @question.Body.Substring(0, Math.Min(question.Body.Length, 150))
                                    @(question.Body.Length > 150 ? "..." : "")
                                </p>

                                <div class="text-muted small d-flex justify-content-between">
                                    <span>
                                        <i class="fa-solid fa-user-graduate me-1"></i>
                                        @question.Student?.FullName
                                    </span>

                                    <span>
                                        <i class="fa-solid fa-calendar me-1"></i>
                                        @question.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                    </span>

                                    <span>
                                        <i class="fa-solid fa-reply me-1"></i>
                                        @question.Answers.Count trả lời
                                    </span>
                                </div>
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>
